NEJ.define(["base/global","base/klass","base/event","base/element","base/util","util/event"],function(t,e,_,i,s,n,o,l,c,h){var a,d="test-"+ +new Date;return o._$$MultiSelector=e._$klass(),a=o._$$MultiSelector._$extend(n._$$EventTarget),a.__reset=function(t){this.__super(t),this.__last=d,this.__selection={count:0},this.__kname=t.name||"id",this.__kfcls=t.item||"js-item",this.__parent=i._$get(t.parent),this.__selected=t.selected||"js-selected",this.__list=i._$getByClassName(this.__parent,this.__kfcls),this.__parent.tabIndex=1e4,this.__doInitDomEvent([[this.__parent,"keydown",this.__onItemSelectAll._$bind(this)],[this.__parent,"mouseup",this.__onItemSelect._$bind(this)],[this.__parent,"mousedown",this.__onItemSelectCheck._$bind(this)]]),s._$forEach(this.__list,function(t){i._$hasClassName(t,this.__selected)&&this.__doItemAddToSelection(i._$dataset(t,this.__kname),t)},this)},a.__destroy=function(){this.__super(),this.__doItemClear(),delete this.__last,delete this.__list,delete this.__parent,delete this.__selected,delete this.__selection},a.__isItemSelected=function(t){return!!this.__selection[t]},a.__doItemAddToSelection=function(t,e){this.__selection[t]||(i._$addClassName(e,this.__selected),this.__selection[t]=i._$id(e),this.__selection.count++)},a.__doItemDelFromSelection=function(t,e){this.__selection[t]&&(i._$delClassName(e,this.__selected),delete this.__selection[t],this.__selection.count--)},a.__doItemClear=function(t){s._$loop(this.__selection,function(e,_){_!=t&&"list"!=_&&"count"!=_&&this.__doItemDelFromSelection(_,e)},this)},a.__onItemClear=function(t){t.ctrlKey||t.shiftKey||this.__doItemClear()},a.__onItemSelect=function(t){var e=_._$getElement(t,"c:"+this.__kfcls);if(e){_._$stopBubble(t);var n=t.ctrlKey,o=t.shiftKey,l=i._$dataset(e,this.__kname);if(2!=t.button||!this.__isItemSelected(l)){if(n||o||(this.__doItemClear(l),this.__doItemAddToSelection(l,e)),n&&(this.__isItemSelected(l)?this.__doItemDelFromSelection(l,e):this.__doItemAddToSelection(l,e)),o){var c,h,a=!1,c=this.__last!=d?this.__last:i._$dataset(this.__list[0],this.__kname);s._$forEach(this.__list,function(t,e,_){var s=i._$dataset(t,this.__kname);h=s==c||s==l,c!=l&&h&&(a=!a),a||h?this.__doItemAddToSelection(s,t):n||this.__doItemDelFromSelection(s,t)},this)}o||(this.__last=l),this.__doSelectionChange()}}},a.__onItemSelectCheck=function(t){var e=_._$getElement(t,"c:"+this.__kfcls);if(e){_._$stopBubble(t);var s=i._$dataset(e,this.__kname);t.ctrlKey||t.shiftKey||this.__isItemSelected(s)||(this.__doItemClear(s),this.__doItemAddToSelection(s,e),this.__doSelectionChange())}},a.__onItemSelectAll=function(t){t.ctrlKey&&65==t.keyCode&&(s._$forEach(this.__list,function(t){this.__doItemAddToSelection(i._$dataset(t,this.__kname),t)},this),this.__doSelectionChange())},a.__doSelectionChange=function(){try{this.__selection.count>1&&(document.getSelection?document.getSelection().collapse(document,0):document.selection&&document.selection.empty())}catch(t){}this._$dispatchEvent("onchange")},a._$clear=function(){this.__doItemClear(),this.__doSelectionChange()},a._$getList=function(){return this.__list},a._$getSelection=function(t){var e=s._$merge({},this.__selection);return t&&(_list=[],s._$forEach(this.__list,function(t){var e=i._$dataset(t,this.__kname);this.__isItemSelected(e)&&_list.push(e)},this),e.list=_list),e},CMPT&&t.copy(t.P("nej.ut"),o),o});