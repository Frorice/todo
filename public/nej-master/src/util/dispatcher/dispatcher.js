NEJ.define(["base/global","base/klass","base/element","base/event","base/util","util/history/history","util/template/tpl","util/event","./dsp/util.js","./dsp/node.js","./dsp/group.js","./dsp/single.js","./module.js","{platform}dispatcher.js"],function(t,i,e,_,n,r,o,s,a,h,c,u,f,l,d,$,p,g){var v;return d._$$Dispatcher=i._$klass(),v=d._$$Dispatcher._$extend(s._$$EventTarget),v.__init=function(){this.__super();var t=n._$uniqueID();this.__pbseed="pb-"+t,this.__pvseed="pv-"+t},v.__reset=function(t){this.__dtmp={},this.__rest=!!t.rest,this.__root=h._$$Node._$allocate(),this.__config={m:{},mg:{},r:[],rr:{},al:{},am:{}},this.__groups={},this.__doBuildGroup(this.__pbseed),this.__groups[this.__pvseed]=c._$$GroupManager._$allocate({root:this.__root,dispatcher:this}),l.__doFixHashTitle(document.title),this.__doInitDomEvent([[location,"urlchange",this.__onURLChange._$bind(this)]]),this.__super(t),this._$rule(t.rules),this._$regist(t.modules)},v.__destroy=function(){var t=function(t,i,e){delete e[i],t._$recycle()};return function(){delete this.__config,this.__root=this.__root._$recycle(),n._$loop(this.__groups,t),this.__super()}}(),v.__setModuleConf=function(t,i,e){var _=this.__config.m[t];_||(_={},this.__config.m[t]=_),_[i]=e},v.__getModuleConf=function(t,i){var e=this.__config.m[t];return e?e[i]:""},v.__doBuildGroup=function(t){if(t){var i=this.__groups[t];return i||(i=u._$$GroupManagerSingle._$allocate({root:this.__root,dispatcher:this,classed:t==this.__pbseed}),this.__groups[t]=i),i}},v.__doAddUMI2Group=function(t,i){var e=this.__doBuildGroup(i);e||(i=a._$isUMIPrivate(t)?this.__pvseed:this.__pbseed,e=this.__groups[i]),e._$addUMI(t),this.__config.mg[t]=i},v.__doRewriteUMI=function(){var t=/\$\d/;return function(i,e){var _;return n._$forIn(this.__config.r,function(r){return n._$forIn(r,function(r,o){if(null!=r){if(n._$isFunction(r)){var s=!1;try{s=r.call(null,{umi:i,href:e})}catch(t){}if(s)return _=o,!0}if(n._$isArray(r)){var a=n._$indexOf(r,function(t){return t===i||t===e});if(a>=0)return _=o,!0}return r.test&&(r.test(i)||r.test(e))?(_=t.test(o)?i.replace(r,o):o,!0):r===i||r===e?(_=o,!0):void 0}}),!!_}),_||i}}(),v.__onURLChange=function(){var t=/(?:^\/+)|(?:\/+$)/gi,i=/#(\$.*?)$/,e=/\/$/,_=function(i,e){var _=e._$getPath(),i=i.replace(_,"").replace(t,"");return i.split("/")},n=function(t,i){for(var e,_=t.split("/");_.length>0;)if(_[_.length-1]?_[_.length-1]="":_.pop(),e=i[_.join("/")])return e;return""};return function(t){if(0!=t.path.indexOf("$")){var r=this.__dtmp[t.path];delete this.__dtmp[t.path],this._$dispatchEvent("onbeforechange",t);var o=this.__doRewriteUMI(t.path,t.href),s=this.__config.mg[o];if(!s&&this.__rest&&(s=n(o,this.__config.mg)),!s&&!a._$isUMIPrivate(o)){var h={path:o,href:t.href};if(this._$dispatchEvent("onnotfound",h),h.stopped)return;o=this.__config.rr[404],s=this.__config.mg[o]}if(!s&&this.__rest&&(s=n(o,this.__config.mg)),s){var c=a._$getNodeByUMI(this.__root,o),u=null;this.__rest&&(u=_(o,c),!e.test(o)&&this.__config.mg[o+"/"]&&(c=c._$getChildByName("/")));var f=o;o=c._$getPath(),c._$getData().event={target:o,source:f,href:t.href,param:t.query,input:r,prest:u,clazz:this.__getModuleConf(o,"clazz"),pos:i.test(t.href)?RegExp.$1:""};var h={title:this.__getModuleConf(f,"title")};this._$dispatchEvent("ontitlechange",h),h.title&&(document.title=h.title),this.__groups[s]._$dispatchUMI(o)}}}}(),v.__onClickDelegate=function(){var t=function(t,i){if(t){var e=location.parse(t);this._$dispatchEvent("onbeforechange",e);var _=this.__doRewriteUMI(e.path,i||e.href);return this.__groups[this.__pbseed]._$hasUMI(_)}},i=function(i){var _=e._$dataset(i,"href");if(_)return _;var r=e._$attr(i,"href");if(r&&!e._$dataset(i,"notUmi")){var o=r.split("#");o.shift();var _=o.join("#");if(t.call(this,_,r))return _;if(t.call(this,r)){var s=location.parse(r);return s.path+"?"+n._$object2query(s.query)}}},r=function(t){return!!i.call(this,t)};return function(t){var e=_._$getElement(t,r._$bind(this));e&&(_._$stopDefault(t),this._$redirect(i.call(this,e)))}}(),v.__onActionDelegate=function(t){var i=this.__config.am,n=i[t.type];if(n){var r=_._$getElement(t,"d:resAction");if(r){var o=e._$dataset(r,"resAction")||"",s=n[o.toLowerCase()];if(s){var a={action:o,target:r,id:e._$dataset(r,"resId"),type:e._$dataset(r,"resType"),extra:e._$dataset(r,"resExtra")};this._$dispatchEvent("onbeforeaction",{event:t,target:r,result:a}),s.call(this,a)}}}},v._$rule=function(){var t=["404"],i=function(t,i){this._$rule(i,t)},e=function(t,i){this.__setModuleConf(i,"title",t)},_=function(t,i){this.__config.al[i]=t},r=function(i){i&&(this.__config.r.push(i),n._$forEach(t,function(t){i[t]&&(this.__config.rr[t]=i[t],delete i[t])},this))},o=function(t,i){var e=this.__config.am,_="click",r=t,i=(i||"").toLowerCase();n._$isObject(t)&&(_=t.event||_,r=t.value),n._$isString(r)?r=function(t,i){this._$redirect(t,{force:!0,input:i})}._$bind(this,r):n._$isFunction(r)&&(r=r._$aop(null,function(t){var i=t.value;n._$isString(i)&&this._$redirect(i,{force:!0,input:t.args[0]})}._$bind(this))),n._$isFunction(r)&&(e[_]||(this.__doInitDomEvent([[document,_,this.__onActionDelegate._$bind(this)]]),e[_]={}),e[_][i]=r)},s={title:function(t){n._$loop(t,e,this)},rewrite:function(t){n._$isArray(t)?n._$forEach(t,r,this):r.call(this,t)},alias:function(t){n._$loop(t,_,this)},action:function(t){n._$loop(t,o,this)}};return function(t,e){if(n._$isArray(t))e=t,t="rewrite";else if(!n._$isString(t))return void n._$forIn(t,i,this);(s[t]||p).call(this,e)}}(),v._$regist=function(){var t=function(t,i){this._$regist(i,t)},i=function(t){return!!t&&!!t._$extend};return function(e,_){if(!n._$isString(e))return void n._$forIn(e,t,this);var r=a._$appendNodeByUMI(this.__root,e)._$getData(),o=r.module;if(!a._$isModule(o)&&!i(o)){var o,s=this.__config.mg[e];n._$isString(_)||i(_)?o=_:(_=_||$,s=_.gid,o=_.module,_.title&&this.__setModuleConf(e,"title",_.title),_.clazz&&this.__setModuleConf(e,"clazz",_.clazz),_.composite&&(r.composite=_.composite),_.config&&(r.config=_.config)),this.__doAddUMI2Group(e,s),r.module=o}}}(),v._$message=function(){var t=function(t,i){var e=t._$getData().module;a._$isModule(e)&&e._$dispatchEvent("onmessage",i)},i=[t,function(i,e){for(var _=e.from;i;)i._$getPath()!=_&&t(i,e),i=i._$getParent()},function(i,e){var _=e.from;a._$breadthFirstSearch(i,function(i){i._$getPath()!=_&&t(i,e)})}];return function(t){var e=n._$merge({},t),_=a._$getNodeByUMI(this.__root,e.to);e.path=_._$getPath(),(i[e.mode]||i[0]).call(this,_,e)}}(),v._$publish=function(t,i){var i=n._$merge({},i);i.type=t||"",this._$dispatchEvent((i.from||"")+":"+i.type,i)},v._$subscribe=function(t,i,e){t=this.__config.al[t]||t,this._$addEvent((t||"")+":"+(i||""),e)},v._$unsubscribe=function(t,i,e){t=this.__config.al[t]||t,this._$delEvent((t||"")+":"+(i||""),e)},v._$hide=function(t){var i=this.__config.mg[t];i==this.__pvseed&&this.__groups[i]._$hideUMI(t)},v._$hideGroup=function(t){var i=this.__groups[t];i&&i._$hide()},v._$redirect=function(t,i){i=i||$;var e=a._$path2umi(t),_=location.parse(t);if(this.__dtmp[_.path]=i.input,a._$isUMIPrivate(e))this.__onURLChange(_);else{var n=this.__groups[this.__pbseed],r={target:_,umi:e};(i.exitable||n._$exitable(r))&&(location.same(t)&&i.force?this.__onURLChange(_):(location.ignored=!!i.ignored,location.redirect(t,!!i.replace)))}},v._$refresh=function(t){t?this._$redirect(t,{replace:!0,force:!0}):this.__groups[this.__pbseed]._$refresh()},v._$delegate=function(){this.__doInitDomEvent([[document,"click",this.__onClickDelegate._$bind(this)]])},v._$active=function(){location.active()},v._$loaded=function(t,i){t=this.__config.al[t]||t,n._$isArray(t)?n._$forEach(t,function(t){this._$loaded(t,i)},this):(this._$regist(t,i),this.__groups[this.__config.mg[t]]._$loadedUMI(t))},v._$getTitle=function(t){return this.__getModuleConf(t,"title")},d._$startup=function(t){return window.dispatcher?void console.error("dispatcher is already startup"):(window.dispatcher=d._$$Dispatcher._$getInstance(t),f._$dumpModules(),o._$parseTemplate((t||$).tid||"template-box",location.config),_._$addEvent(document,"templateready",function(){window.setTimeout(dispatcher._$active._$bind(dispatcher),0)}),window.dispatcher)},CMPT&&(t.P("nej.e")._$startup=d._$startup,t.P("nej.ut")._$$Dispatcher=d._$$Dispatcher),d});