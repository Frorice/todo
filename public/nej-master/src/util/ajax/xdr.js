NEJ.define(["base/global","base/constant","base/util","base/element","./proxy/xhr.js","{platform}xdr.js"],function(r,e,n,o,t,a,u,l,i,d){var _={},c=i;return u._$abort=function(r){var e=_[r];e&&e.req._$abort()},u._$filter=function(r){c=r||i},u._$request=function(){var r=(location.protocol+"//"+location.host).toLowerCase(),o=function(e){var o=n._$url2origin(e);return!!o&&o!=r},u=function(r){return(r||l)[e._$HEAD_CT]==e._$HEAD_CT_FILE},d=function(r){var e=u(r.headers);return o(r.url)||e?a.__getProxyByMode(r.mode,e,r):t._$$ProxyXHR._$allocate(r)},s=function(r,e){var n={data:e},o=r.result.headers;return o&&(n.headers=r.req._$header(o)),n},$=function(r){var e=_[r];e&&(e.req&&e.req._$recycle(),delete _[r])},f=function(r,e){var n=_[r];if(n){var o=arguments[2];"onload"==e&&n.result&&(o=s(n,o)),$(r);var t={type:e,result:o};c(t),t.stopped||(n[e]||i)(t.result)}},q=function(r,e){f(r,"onload",e)},v=function(r,e){f(r,"onerror",e)},b=function(r,e){var o=r.indexOf("?")<0?"?":"&",e=e||"";return n._$isObject(e)&&(e=n._$object2query(e)),e&&(r+=o+e),r};return function(r,e){e=e||{};var o=n._$uniqueID(),t={result:e.result,onload:e.onload||i,onerror:e.onerror||i};_[o]=t,e.onload=q._$bind(null,o),e.onerror=v._$bind(null,o),e.query&&(r=b(r,e.query));var a=e.method||"";return a&&!/get/i.test(a)||!e.data||(r=b(r,e.data),e.data=null),e.url=r,t.req=d(e),t.req._$send(e.data),o}}(),u._$upload=function(r,t){if(r=o._$get(r),!r)return"";var a=n._$fetch({mode:0,type:"json",query:null,cookie:!1,headers:{},onload:null,onerror:null,onuploading:null,onbeforerequest:null},t);return a.data=r,a.method="POST",a.timeout=0,a.headers[e._$HEAD_CT]=e._$HEAD_CT_FILE,u._$request(r.action,a)},CMPT&&r.copy(r.P("nej.j"),u),u});