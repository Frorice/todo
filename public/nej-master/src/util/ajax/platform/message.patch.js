NEJ.define(["./message.js","base/util","base/event"],function(e,n,t,r,i,a,o){return NEJ.patch("4.0<=TR<=5.0",function(){e.__formatPassData=function(e){return JSON.stringify(e)}}),NEJ.patch("TR<=3.0",["util/event/event","util/encode/json"],function(r){var a="MSG|",o=[],s=function(){var r=unescape(window.name||"").trim();if(r&&0==r.indexOf(a)){window.name="";var i=n._$string2object(r.replace(a,""),"|"),o=(i.origin||"").toLowerCase();o&&"*"!=o&&0!=location.href.toLowerCase().indexOf(o)||t._$dispatchEvent(window,"message",{data:JSON.parse(i.data||"null"),source:window.frames[i.self]||i.self,origin:e.__formatOrigin(i.ref||document.referrer)})}},f=function(){var e,t=function(t,r,i){n._$indexOf(e,t.w)<0&&(e.push(t.w),i.splice(r,1),t.w.name=t.d)};return function(){e=[],n._$reverseEach(o,t),e=null}}();e.__postMessage=function(){var e=function(e){var t={};return e=e||i,t.origin=e.origin||"",t.ref=location.href,t.self=e.source,t.data=JSON.stringify(e.data),a+n._$object2string(t,"|",!0)};return function(n,t){o.unshift({w:n,d:escape(e(t))})}}(),r._$$CustomEvent._$allocate({element:window,event:"message"}),setInterval(f,100),setInterval(s,20)}),e});