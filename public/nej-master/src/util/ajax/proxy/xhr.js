NEJ.define(["./proxy.js","base/util","base/klass","base/constant","{platform}xhr.js"],function(t,e,_,a,s,n,i,r,h){var o;return n._$$ProxyXHR=_._$klass(),o=n._$$ProxyXHR._$extend(t._$$ProxyAbstract),o.__destroy=function(){this.__super(),window.clearTimeout(this.__timer),delete this.__timer;try{this.__xhr.onreadystatechange=r,this.__xhr.abort()}catch(t){}delete this.__xhr},o.__doSendRequest=function(){var t=function(t,e){this.__xhr.setRequestHeader(e,t)},_=function(t){var _=[];return e._$reverseEach(t.getElementsByTagName("input"),function(t){if("file"==t.type)return t.name?void(t.files.length>1&&(e._$forEach(t.files,function(e){_.push({name:t.name,file:e})}),t.parentNode.removeChild(t))):void t.parentNode.removeChild(t)}),_.length>0?_:null};return function(n){var i=n.request,r=n.headers;if(this.__xhr=s.__getXMLHttpRequest(),r[a._$HEAD_CT]===a._$HEAD_CT_FILE&&(delete r[a._$HEAD_CT],this.__xhr.upload.onprogress=this.__onStateChange._$bind(this,1),"FORM"===i.data.tagName)){var h=_(i.data);i.data=new FormData(i.data),e._$forEach(h,function(t){var _=t.file;i.data.append(t.name||_.name||"file-"+e._$uniqueID(),_)})}this.__xhr.onreadystatechange=this.__onStateChange._$bind(this,2),this.__xhr.onabort=this.__onAbort._$bind(this),0!==i.timeout&&(this.__timer=window.setTimeout(this.__onStateChange._$bind(this,3),i.timeout)),this.__xhr.open(i.method,i.url,!i.sync),e._$loop(r,t,this),this.__request.cookie&&"withCredentials"in this.__xhr&&(this.__xhr.withCredentials=!0),r[a._$HEAD_CT]!==a._$HEAD_CT_FORM||window.FormData&&i.data instanceof window.FormData||e._$isObject(i.data)&&(i.data=e._$object2string(i.data,"&",!0)),this.__xhr.send(i.data)}}(),o.__onStateChange=function(t){switch(t){case 1:this._$dispatchEvent("onuploading",arguments[1]);break;case 2:4==this.__xhr.readyState&&this.__onLoadRequest({status:this.__xhr.status,result:this.__xhr.responseText||""});break;case 3:this.__onLoadRequest({status:-1})}},o.__getResponseHeader=function(t){return this.__xhr?this.__xhr.getResponseHeader(t):""},o._$abort=function(){s.__hasAbortEvent()?(this.__xhr.onreadystatechange=r,this.__xhr.abort()):this.__onAbort()},n});