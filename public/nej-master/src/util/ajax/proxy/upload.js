NEJ.define(["./proxy.js","base/klass","base/util","base/event","base/element","base/constant","util/ajax/xdr","util/ajax/message"],function(e,t,n,i,o,_,r,a,s,d,u,c){var h,m={},$="NEJ-UPLOAD-RESULT:";return s._$$ProxyUpload=t._$klass(),h=s._$$ProxyUpload._$extend(e._$$ProxyAbstract),h.__init=function(){var e=!1,t=function(e){var t=e.data;if(0==t.indexOf($)){t=JSON.parse(t.replace($,""));var n=m[t.key];n&&(delete m[t.key],n.__onLoadRequest(decodeURIComponent(t.result)))}},n=function(){e||(e=!0,i._$addEvent(window,"message",t))};return function(){this.__super(),n()}}(),h.__destroy=function(){this.__super(),o._$remove(this.__frame),delete this.__frame,window.clearTimeout(this.__timer),delete this.__timer},h.__onLoadRequest=function(e){try{var t=o._$text2type(e,this.__request.type);this._$dispatchEvent("onload",t)}catch(t){this._$dispatchEvent("onerror",{code:_._$CODE_ERREVAL,message:e})}},h.__doSendRequest=function(){var e=function(){var e,t;try{var e=this.__frame.contentWindow.document.body,t=(e.innerText||e.textContent||"").trim();if(t.indexOf($)>=0||e.innerHTML.indexOf($)>=0)return}catch(e){return}this.__onLoadRequest(t)},t=function(e,n,i){r._$request(e,{type:"json",method:"POST",cookie:i,mode:parseInt(n)||0,onload:function(o){this.__timer&&(this._$dispatchEvent("onuploading",o),this.__timer=window.setTimeout(t._$bind(this,e,n,i),1e3))}._$bind(this),onerror:function(o){this.__timer&&(this.__timer=window.setTimeout(t._$bind(this,e,n,i),1e3))}._$bind(this)})};return function(r){var a=r.request,s=(r.headers,a.data),u=n._$uniqueID();m[u]=this,s.target=u,s.method="POST",s.enctype=_._$HEAD_CT_FILE,s.encoding=_._$HEAD_CT_FILE;var c=s.action||"",h=c.indexOf("?")<=0?"?":"&";s.action=c+h+"_proxy_=form",this.__frame=o._$createXFrame({name:u,onload:function(n){var o=i._$getElement(n);i._$addEvent(o,"load",e._$bind(this)),s.submit();var _=(s.nej_query||d).value;if(_){var r=(s.nej_mode||d).value,a="true"===(s.nej_cookie||d).value;this.__timer=window.setTimeout(t._$bind(this,_,r,a),100)}}._$bind(this)})}}(),h._$abort=function(){this.__onAbort()},s});