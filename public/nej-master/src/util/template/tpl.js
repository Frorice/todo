NEJ.define(["base/global","base/util","base/event","base/element","base/platform","util/template/jst","util/event/event","util/ajax/tag","util/ajax/xdr","base/chain"],function(e,t,n,a,r,o,i,l,u,d,c,$,_,s){var m={},f="ntp-"+ +new Date+"-";return c.tpl=function(){return m},c._$parseTemplate=function(){var e=0,d=function(){e>0||(e=0,n._$dispatchEvent(document,"templateready"),n._$clearEvent(document,"templateready"))},_=function(e,n){var r=a._$dataset(e,"src");if(r){n=n||$;var o=n.root;return o=o?t._$absolute(o):e.ownerDocument.location.href,r=r.split(","),t._$forEach(r,function(e,n,a){a[n]=t._$absolute(e,o)}),r}},s=function(e){return r._$is("mac")&&"safari"===r._$KERNEL.browser?t._$unescape(e.innerHTML):e.value||e.innerText||""},m=function(e,t){if(e){var n=_(e,t);n&&l._$queueStyle(n,{version:a._$dataset(e,"version")}),a._$addStyle(e.value)}},f=function(t){e--,a._$addScript(t),d()},p=function(t,n){if(t){var r=_(t,n),o=t.value;if(r){e++;var n={version:a._$dataset(t,"version"),onload:f._$bind(null,o)};return void window.setTimeout(l._$queueScript._$bind(l,r,n),0)}a._$addScript(o)}},v=function(t){e--,c._$parseTemplate(t),d()},T=function(t,n){if(t){var r=_(t,n)[0];if(r){e++;var n={version:a._$dataset(t,"version"),onload:v};window.setTimeout(l._$loadHtml._$bind(l,r,n),0)}}},g=function(t,n){e--,c._$addTextTemplate(t,n||""),d()},b=function(t,n){if(t&&t.id){var r=t.id,o=_(t,n)[0];if(o){e++;var i=o+(o.indexOf("?")<0?"?":"&")+(a._$dataset(t,"version")||""),n={type:"text",method:"GET",onload:g._$bind(null,r)};window.setTimeout(u._$request._$bind(u,i,n),0)}}},y=function(e,t){var n=e.name.toLowerCase();switch(n){case"jst":return void o._$addTemplate(s(e),e.id);case"txt":return void c._$addTextTemplate(e.id,s(e));case"ntp":return void c._$addNodeTemplate(s(e),e.id);case"js":return void p(e,t);case"css":return void m(e,t);case"html":return void T(e,t);case"res":return void b(e,t)}};return i._$$CustomEvent._$allocate({element:document,event:"templateready",oneventadd:d}),function(e,n){if(e=a._$get(e)){var r="TEXTAREA"==e.tagName?[e]:t._$object2array(e.getElementsByTagName("textarea"));t._$forEach(r,function(e){y(e,n)}),a._$remove(e,!0)}d()}}(),c._$addTextTemplate=function(e,t){null!=m[e]&&typeof m[e]==typeof t&&(console.warn("text template overwrited with key "+e),console.debug("old template content: "+m[e].replace(/\n/g," ")),console.debug("new template content: "+t.replace(/\n/g," "))),m[e]=t||""},c._$getTextTemplate=function(e){return m[e]||""},c._$addNodeTemplate=function(e,n){return n=n||t._$uniqueID(),e=a._$get(e)||e,c._$addTextTemplate(f+n,e),t._$isString(e)||a._$removeByEC(e),n},c._$getNodeTemplate=function(e){if(!e)return null;e=f+e;var n=c._$getTextTemplate(e);if(!n)return null;var r;if(t._$isString(n)){n=a._$html2node(n);var o=n.getElementsByTagName("textarea");"TEXTAREA"==n.tagName||o&&o.length?r=n:c._$addTextTemplate(e,n)}return r||(r=n.cloneNode(!0)),a._$removeByEC(r),r},c._$getItemTemplate=function(){var e=function(e,t){return"offset"==t||"limit"==t};return function(n,a,r){var o=[];if(!n||!n.length||!a)return o;r=r||$;var i=n.length,l=parseInt(r.offset)||0,u=Math.min(i,l+(parseInt(r.limit)||i)),d={total:n.length,range:[l,u]};t._$merge(d,r,e);for(var c,_=l;_<u;_++){d.index=_,d.data=n[_],c=a._$allocate(d);var s=c._$getId();m[s]=c,c._$recycle=c._$recycle._$aop(function(e,t){delete m[e],delete t._$recycle}._$bind(null,s,c)),o.push(c)}return o}}(),c._$getItemById=function(e){return m[e]},c._$parseUITemplate=function(){var e=/#<(.+?)>/g;return function(n,r){return r=r||{},n=(n||"").replace(e,function(e,n){var a=r[n];return a||(a="tpl-"+t._$uniqueID(),r[n]=a),a}),c._$parseTemplate(a._$html2node(n)),r}}(),d._$merge({_$parseTemplate:c._$parseTemplate,_$addNodeTemplate:c._$addNodeTemplate}),CMPT&&e.copy(e.P("nej.e"),c),c});