NEJ.define(["base/platform","base/element","base/event","base/util","./editor.js"],function(e,n,t,o,r,i,a,c,u){return NEJ.patch("WV",function(){var e=/<\/?[\w]+:[\w]+.*?>/gi,n=function(e){return(e||"").search("</?[\\w]+:[\\w]+.*?>")>=0};r.__filterWordContent=function(t){return n(t)?t.replace(e,""):t}}),NEJ.patch("GV",function(){var e=/(?:<(p|div)>(?:\&nbsp\;|<br\/?>)<\/\1>|<br\/?>|\&nbsp\;|\s)+$/gi,n=/\f/g,i=/\n|\r/g,a=/<(style|script).*?>.*?<\/\1>/gi,c=/<\/?(?:meta|link|!--\[.+?\]--|[\w]+:[\w]+).*?>/gi,u=/<img(\n|\r|\s|[^>])*?src="data:image\/png;base64[^>]*?>/gi,_=function(e){return(e||"").indexOf("<w:WordDocument>")>=0};r.__filterWordContent=function(t){return _(t)?t.replace(i,"\f").replace(c,"").replace(a,"").replace(n,"\n").replace(u,"").replace(e,""):t},r.__filterContentPath=function(e){return e=e.replace(u,"")},r.__insertHtml=function(e,n){var t=r.__getWindow(e),i=r.__getRange(t),a=e.createElement("div");a.innerHTML=n,i.deleteContents(),o._$reverseEach(a.childNodes,function(e){i.insertNode(e)});var c=r.__getSelection(t);c.collapseToEnd(),t.focus()},r.__supportSelectionChange=function(){var e,n=/^Mac/.test(navigator.platform),o=[65,66,69,70,78,80],i=n?"metaKey":"ctrlKey",a=["startContainer","startOffset","endContainer","endOffset"],c={INPUT:1,TEXTAREA:1},u=function(){return"undefined"!=typeof WeakMap?new WeakMap:null},_=function(e){var n=r.__getSelection(r.__getWindow(e));return n.rangeCount?n.getRangeAt(0):null},s=function(e){c[e.target.tagName]||p(this,!0)},l=function(e){var t=e.keyCode;(65===t&&e[i]&&!e.shiftKey&&!e.altKey||t>=37&&t<=40||e.ctrlKey&&n&&o.indexOf(t)>=0)&&(c[e.target.tagName]||setTimeout(p.bind(null,this),0))},f=function(e){0===e.button&&(t._$addEvent(this,"mousemove",d),setTimeout(p.bind(null,this),0))},d=function(e){1&e.buttons?p(this):t._$delEvent(this,"mousemove",d)},g=function(e){0===e.button?setTimeout(p.bind(null,this),0):t._$delEvent(this,"mousemove",d)},v=function(){setTimeout(p.bind(null,this.document),0)},p=function(n,o){var r=_(n);!o&&m(r,e.get(n))||(e.set(n,r),setTimeout(function(){console.log("selectionchange"),t._$dispatchEvent(n,"selectionchange")},0))},m=function(e,n){return e===n||e&&n&&a.every(function(t){return e[t]===n[t]})},h=function(e){var n=e.onselectionchange;if(void 0!==n)try{return e.onselectionchange=0,null===e.onselectionchange}catch(e){}finally{e.onselectionchange=n}return!1};return function(n){var o=n||document;(e||!h(o)&&(e=u()))&&(e.has(o)||(e.set(o,_(o)),t._$addEvent(o,"input",s),t._$addEvent(o,"keydown",l),t._$addEvent(o,"mousedown",f),t._$addEvent(o,"mousemove",d),t._$addEvent(o,"mouseup",g),t._$addEvent(o.defaultView,"focus",v)))}}()}),NEJ.patch("PV",function(){var e=/<\/?[\w]+:[\w]+.*?>/gi,n="";r.__execCommand=r.__execCommand._$aop(function(e){var n=e.args;"hiliteColor"==n[1]&&(n[1]="backColor")});var t=function(e){return(e||"").search("</?[\\w]+:[\\w]+.*?>")>=0};r.__filterWordContent=function(n){return t(n)?n.replace(e,""):n},r.__filterContentPath=function(e){return e.replace(n,"&nbsp;")}}),NEJ.patch("TR",function(){var e=/<\/?[\w]+:[\w]+.*?>/gi,n=/<\?xml[^>]*>/gi,t=function(e){return(e||"").search("</?[\\w]+:[\\w]+.*?>")>=0};r.__filterWordContent=function(o){return t(o)?o.replace(e,"").replace(n,""):o}}),NEJ.patch("TR<=4.0",function(){r.__getSelectText=function(e){var n=r.__getRange(e);return n?n.text:""},r.__getSelectHtml=function(e){var n=r.__getRange(e);if(!n)return"";var t=n.htmlText;return t||""}}),NEJ.patch("TR<=4.0",function(){r.__moveCursorPosition=function(){var e=[function(e){return e.innerText.length},function(){return 0}];return r.__moveCursorPosition._$aop(function(n){var t=n.args,o=r.__getRange(r.__getWindow(t[0]));if(o&&o.move){n.stopped=!0;var i=e[t[1]];if(!i)return;o.move("character",i(t[0])),o.select()}})}()}),NEJ.patch("TR>=6.0",["./editor.td.js"],function(){var e=NEJ.P,n=(e("nej.u"),e("nej.p"),e("nej.h")),t=/<\/?[\w]+:[\w]+.*?>/gi,o=function(e){return(e||"").search("</?[\\w]+:[\\w]+.*?>")>=0};n.__filterWordContent=function(e){return o(e)?e.replace(t,""):e}}),NEJ.patch("TR>=3.0",function(){var e={};r.__execCommand=r.__execCommand._$aop(function(e){var n=e.args;return"styleWithCSS"==n[1]?void(e.stopped=!0):(r.__focusRange(n[0].body),void("hiliteColor"==n[1]&&(n[1]="backColor")))}),r.__saveRange=r.__saveRange._$aop(function(t){if(document.selection){t.stopped=!0;var o=t.args[0],i=r.__getDocument(o),a=n._$id(i);e[a]=r.__getRange(r.__getWindow(i))}}),r.__focusRange=r.__focusRange._$aop(null,function(t){var o=r.__getDocument(t.args[0]),i=n._$id(o),a=e[i];if(a){if(a.select)a.select();else{var c=r.__getSelection(r.__getWindow(o));c.addRange(a)}delete e[i]}}),r.__clearRange=r.__clearRange._$aop(null,function(t){var o=n._$id(r.__getDocument(t.args[0]));delete e[o]}),r.__getRcache=function(){return e}}),NEJ.patch("TR>=5.0",function(){r.__saveRange=r.__saveRange._$aop(function(e){if(!document.selection){e.stopped=!0;var t=e.args[0],o=r.__getDocument(t),i=n._$id(o),a=r.__getRcache();a[i]=r.__getRange(r.__getWindow(o))}}),r.__insertHtml=function(e,n){var t=r.__getWindow(e),i=r.__getRange(t),a=e.createElement("div");a.innerHTML=n,i.deleteContents(),o._$reverseEach(a.childNodes,function(e){i.insertNode(e)});var c=r.__getSelection(t);c.collapseToEnd(),t.focus()},r.__moveCursorPosition=function(){var e=[function(e){return e.innerText.length},function(){return 0}];return r.__moveCursorPosition._$aop(function(n){var t=n.args,o=t[0],i=t[1],a=e[i],c=r.__getSelection(r.__getWindow(o));if(2!=i){if(3==i){var u=c.focusOffset;o=c.focusNode||o,c.collapse(o,u)}else c.collapse(o,a(o));n.stopped=!0}})}()}),r});