NEJ.define(["base/global","base/klass","base/util","util/cache/cache"],function(t,_,e,i,n,r,s,h){var a;return n._$$StorageManager=_._$klass(),a=n._$$StorageManager._$extend(i._$$CacheAbstract),a.__reset=function(){var t={};return function(_){this.__super(_),this.__pkey=_.key||"id",this.__prefix=""+(_.prefix||""),this.__limit=parseInt(_.limit)||500,t[this.__prefix]||(t[this.__prefix]=!0,this.__doInitDataFromStorage())}}(),a.__destroy=function(){this.__super(),delete this.__pkey,delete this.__limit,delete this.__prefix},a.__doInitDataFromStorage=function(){var t,_=this.__prefix,i=this.__getIndex();e._$forIn(this.__getDataInStorage(_+"index"),function(e,n){return n==_+"blen"?void(t=e):void(i[n]={ref:e.r,block:e.b})}),this.__setDataInCache(_+"blen",t||[])},a.__getIndex=function(){return this.__getDataInCacheWithDefault(this.__prefix+"index",{})},a.__getData=function(){return this.__getDataInCacheWithDefault(this.__prefix+"data",{})},a.__getBlock=function(){return this.__getDataInCacheWithDefault(this.__prefix+"block",[])},a.__getBlockLen=function(){return this.__getDataInCacheWithDefault(this.__prefix+"blen",[])},a.__getBlockIndex=function(){var t=-1,_=this.__getBlock(),i=this.__getBlockLen();return e._$forIn(i,function(e,i){var n=_[i];return n&&n.length<this.__limit?(t=i,!0):!n&&e<this.__limit&&(this.__doLoadBlock(i),_[i].length<this.__limit)?(t=i,!0):void 0},this),t<0&&(t=i.length,i.push(0),_[t]=[]),t},a.__doLoadBlock=function(t){var _=[],i=this.__getData(),n=this.__getIndex(),r=this.__getDataInStorage(this.__prefix+t);e._$forEach(r,function(e){var r=e[this.__pkey],s=n[r]||{};s.block=t,n[r]=s,i[r]=e,_.push(r)},this),this.__getBlock()[t]=_},a.__doFlushIndex=function(){var t={};e._$forIn(this.__getIndex(),function(_,e){var i={b:_.block};null!=_.ref&&(i.r=_.ref),t[e]=i});var _=[];e._$forEach(this.__getBlock(),function(t){_.push(t.length)}),t[this.__prefix+"blen"]=_,this.__setDataInStorage(this.__prefix+"index",t)},a.__doFlushBlock=function(t){var _=this.__getBlock();if(null==t)e._$forIn(_,function(t,_){this.__doFlushBlock(_)},this);else if(e._$isArray(t))e._$forEach(t,this.__doFlushBlock,this);else{var i=[];e._$forEach(_[t],function(t){var _=this._$get(t);_&&i.push(_)},this),this.__setDataInStorage(this.__prefix+t,i)}},a._$get=function(t){if(!e._$isArray(t)){var _=this.__getData();if(!_[t]){var i=this.__getIndex(),n=i[t];if(!n||null==n.block)return;var r=n.block,s=this.__getBlock();if(s[r])return;this.__doLoadBlock(r)}return _[t]}var h=[];return e._$forEach(t,function(t){h.push(this._$get(t))},this),h},a._$add=function(){var t;return function(_){var i;if(e._$isArray(_))t=[],e._$forEach(_,this._$add,this),i=t,t=null;else{var n=_[this.__pkey],r=this._$get(n),s=this.__getIndex();if(r){var h=s[n],a=h.ref;return h.ref=a?a+1:1,this._$update(_),void this.__doFlushIndex()}this.__getData()[n]=_,i=this.__getBlockIndex();var o=this.__getBlock()[i];e._$indexOf(o,n)<0&&o.push(n),s[n]={ref:1,block:i}}return t?void(e._$indexOf(t,i)<0&&t.push(i)):(this.__doFlushIndex(),void this.__doFlushBlock(i))}}(),a._$delete=function(){var t;return function(_){if(e._$isArray(_))t=[],e._$forEach(_,this._$delete,this),this.__doFlushBlock(t),t=null;else{var i=this._$get(_);if(!i)return;var n=this.__getIndex(),s=n[_]||r;if(s.ref>1)s.ref--;else{delete n[_];var h=s.block,a=this.__getBlock()[h],o=e._$indexOf(a,_);o>=0&&(a.splice(o,1),t?e._$indexOf(t,h)<0&&t.push(h):this.__doFlushBlock(h))}}t||this.__doFlushIndex()}}(),a._$update=function(_){var e=_[this.__pkey],i=this._$get(e);if(!i)return void this._$add(i);var n=!1;if(t.X(i,_,function(t,_){n=n||t!==i[_]}),n){var s=this.__getIndex(),h=s[e]||r,a=h.block;null!=a&&this.__doFlushBlock(a)}},a._$migrate=function(t){var _=[];e._$forIn(t,function(t){_.push(t)}),this._$add(_)},a._$syncRef=function(t){var _=this.__getIndex();e._$forIn(t,function(t,e){var i=_[e]||{};i.ref=t,_[e]=i},this),this.__doFlushIndex()},CMPT&&t.copy(t.P("nej.ut"),n),n});