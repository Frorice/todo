NEJ.define(["base/global","base/klass","base/util","./cache.js"],function(t,e,i,_,s,n,a,h){var o;return s._$$CacheList=e._$klass(),o=s._$$CacheList._$extend(_._$$CacheAbstract),o.__reset=function(t){this.__super(t),this.__key=t.key||"id",this.__data=t.data||n,this.__auto=!!t.autogc,this.__doSwapCache(t.id)},o.__destroy=function(){this.__super(),this.__timer&&this.__doGCAction()},o.__doSwapCache=function(t){var e;t&&(e=this.__cache[t],e||(e={},this.__cache[t]=e)),e=e||this.__cache,e.hash=e.hash||{},this.__lspl=e},o.__doGCAction=function(){this.__timer=window.clearTimeout(this.__timer);var t={};i._$loop(this.__lspl,function(e,_){"hash"!=_&&i._$isArray(e)&&i._$forEach(e,function(e){e&&(t[e[this.__key]]=!0)},this)},this),i._$loop(this.__getHash(),function(e,i,_){t[i]||delete _[i]})},o.__doGCSchedule=function(){this.__timer&&(this.__timer=window.clearTimeout(this.__timer)),this.__timer=window.setTimeout(this.__doGCAction._$bind(this),150)},o.__doSaveItemToCache=function(t,e){if(!i._$isArray(t)){if(t=this.__doFormatItem(t,e)||t,!t)return null;var _=t[this.__key];if(null!=_){var s=this.__getHash()[_];s&&(t=i._$merge(s,t)),this.__getHash()[_]=t}return delete t.__dirty__,t}var n=[];return i._$forEach(t,function(t){n.push(this.__doSaveItemToCache(t,e))},this),n},o.__doRemoveItemFromList=function(t,e){var _=null,s=this.__key;if(!i._$isArray(e)){var _=null,s=this.__key;e=e[s]||e;var n=this._$getListInCache(t),a=i._$indexOf(n,function(t){return!!t&&t[s]==e});return a>=0&&(_=n[a],n.splice(a,1)),_}var _=[];return i._$reverseEach(e,function(e){_.unshift(this.__doRemoveItemFromList(t,e))},this),_},o.__doFormatItem=a,o.__doUnshiftToList=function(t,e){if(e){if(!i._$isArray(e)){var _=this._$getListInCache(t),e=this.__doSaveItemToCache(e,t);return void(e&&_.unshift(e))}i._$reverseEach(e,function(e){this.__doUnshiftToList(t,e)},this)}},o._$setTotal=function(t,e){var i=this._$getListInCache(t);i.length=Math.max(i.length,e),this._$setLoaded(t)},o._$getTotal=function(t){return this._$getListInCache(t).length},o._$setLoaded=function(t,e){this._$getListInCache(t).loaded=e!==!1},o._$isLoaded=function(t){return!!this._$getListInCache(t).loaded},o._$setListInCache=function(t,e){this._$clearListInCache(t),this.__getList({key:t,offset:0,limit:e.length+1},{list:e,total:e.length})},o._$getListInCache=function(){var t=function(t){return(t||"")+(t?"-":"")+"list"};return function(e){var e=t(e),i=this.__lspl[e];return i||(i=[],this.__lspl[e]=i),i}}(),o.__getHash=function(){var t=this.__lspl.hash;return t||(t={},this.__lspl.hash=t),t},o._$pullRefresh=function(){var t=function(t){return"r-"+t.key};return function(e){var _=i._$merge({},e),s=t(_),n=this._$dispatchEvent._$bind(this);this.__doQueueRequest(s,n)||(_.rkey=s,_.onload=this.__pullRefresh._$bind(this,_),this._$dispatchEvent("dopullrefresh",_))}}(),o.__pullRefresh=function(t,e){var i=t.key,_=parseInt(e.total),s=e.list||e.result;this.__doUnshiftToList(i,s||e),!isNaN(_)&&s&&(this._$getListInCache(i).length=_,this._$setLoaded(i)),this.__doCallbackRequest(t.rkey,"onpullrefresh",t)},o._$getList=function(){var t=function(t){return"r-"+t.key+"-"+t.offset+"-"+t.limit};return function(e){e=e||n;var i={key:""+e.key||"",ext:e.ext||null,data:e.data||null,offset:parseInt(e.offset)||0,limit:parseInt(e.limit)||0},_=this._$getListInCache(i.key),s=this.__hasFragment(_,i.offset,i.limit);if(s)return void this._$dispatchEvent("onlistload",i);var a=t(i),h=this._$dispatchEvent._$bind(this);this.__doQueueRequest(a,h)||(i.rkey=a,i.onload=this.__getList._$bind(this,i),this._$dispatchEvent("doloadlist",i))}}(),o.__getList=function(){var t=function(t,e,i){return!!t||void i.splice(e,1)};return function(e,_){if(e=e||n,!_)return void this.__doCallbackRequest(e.rkey,"onlistload",e);var s=e.key,a=e.offset,h=this._$getListInCache(s),o=_||[];if(!i._$isArray(o)){o=_.result||_.list||[];var r=parseInt(_.total);(!isNaN(r)||r>o.length)&&this._$setTotal(s,r)}i._$forEach(o,function(t,e){h[a+e]=this.__doSaveItemToCache(t,s)},this),o.length<e.limit&&(this._$setLoaded(s),i._$reverseEach(h,t)),this.__doCallbackRequest(e.rkey,"onlistload",e)}}(),o._$clearListInCache=function(){var t=function(t,e,i){i.splice(e,1)};return function(e){if(i._$isString(e)){var _=this._$getListInCache(e);i._$reverseEach(_,t),this._$setLoaded(e,!1),this.__auto&&this.__doGCSchedule()}else i._$loop(this.__lspl,function(t,e){"hash"!=e&&i._$isArray(t)&&(e=e.substr(0,e.length-5),this._$clearListInCache(e))},this)}}(),o.__doCheckItemValidity=function(t,e){return!t.__dirty__},o._$getItemInCache=function(t){return this.__getHash()[t]},o._$clearItemInCache=function(t){var e=this._$getItemInCache(t);e&&(e.__dirty__=!0)},o._$getItem=function(){var t=function(t){return"r-"+t.key+"-"+t.id};return function(e){e=e||n;var i=e[this.__key],_={id:i,ext:e.ext,data:e.data||{},key:""+e.key||""};if(_item=this._$getItemInCache(i),_.data[this.__key]=i,_item&&this.__doCheckItemValidity(_item,_.key))return void this._$dispatchEvent("onitemload",_);var s=t(_),a=this._$dispatchEvent._$bind(this);this.__doQueueRequest(s,a)||(_.rkey=s,_.onload=this.__getItem._$bind(this,_),this._$dispatchEvent("doloaditem",_))}}(),o.__getItem=function(t,e){t=t||n,this.__doSaveItemToCache(e,t.key),this.__doCallbackRequest(t.rkey,"onitemload",t)},o._$addItem=function(t){t=i._$merge({},t),t.onload=this.__addItem._$bind(this,t),this._$dispatchEvent("doadditem",t)},o.__addItem=function(t,e){var i=t.key;if(e=this.__doSaveItemToCache(e,i)){var _=0,s=this._$getListInCache(i);if(t.push)s.loaded?(_=1,s.push(e)):s.length++;else{_=-1;var n=t.offset||0;s.splice(n,0,e)}}var a={key:i,flag:_,data:e,action:"add",ext:t.ext};return this._$dispatchEvent("onitemadd",a),a},o._$deleteItem=function(t){t=i._$merge({},t),t.onload=this.__deleteItem._$bind(this,t),this._$dispatchEvent("dodeleteitem",t)},o.__deleteItem=function(t,e){var i,_=t.key;if(e){var s=t.id;i=this._$getItemInCache(s)||null,this.__doRemoveItemFromList(_,s)}var n={key:_,data:i,action:"delete",ext:t.ext};return this._$dispatchEvent("onitemdelete",n),n},o._$updateItem=function(t){t=i._$merge({},t),t.onload=this.__updateItem._$bind(this,t),this._$dispatchEvent("doupdateitem",t)},o.__updateItem=function(t,e){var i=t.key;e&&(e=this.__doSaveItemToCache(e,i));var _={key:i,data:e,action:"update",ext:t.ext};return this._$dispatchEvent("onitemupdate",_),_},CMPT&&(t.P("nej.ut")._$$ListCache=s._$$CacheList),s});