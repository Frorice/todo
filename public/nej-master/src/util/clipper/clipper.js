NEJ.define(["base/global","base/klass","base/constant","base/element","base/util","util/event","ui/resizer/resizer"],function(i,t,e,_,h,o,s,r,a,n,d){var l;return r._$$Clipper=t._$klass(),l=r._$$Clipper._$extend(o._$$EventTarget),l.__init=function(){this.__image=new Image,this.__ropt={onmove:this.__onClipping._$bind(this),onresize:this.__onClipping._$bind(this)},this.__super()},l.__reset=function(i){this.__super(i),this.__doInitDomEvent([[this.__image,"load",this.__onImageLoad._$bind(this,!0)],[this.__image,"error",this.__onImageLoad._$bind(this,!1)]]),this.__pbox={},this.__mbox=_._$get(i.mbox),this.__sopt=h._$fetch({lock:!1,size:null},i);var t=i.pbox;h._$isArray(t)?h._$forEach(t,this._$addPreview,this):this._$addPreview(t),this._$setURL(i.url)},l.__destroy=function(){this.__super(),this.__doClearResizer(),this.__doClearPreview(),this.__image.src=e._$BLANK_IMAGE},l.__doClearResizer=function(){_._$remove(this.__cbox),delete this.__cbox,this.__resizer&&(this.__resizer._$recycle(),delete this.__resizer)},l.__doClearPreview=function(i){h._$forIn(this.__pbox,function(t){var h=_._$get(t.img);h&&(i?h.src=e._$BLANK_IMAGE:_._$remove(h))})},l.__doCalImagePosition=function(i,t){var e=i.width/i.height,_=t.width/t.height,h={};return _<e&&t.width<i.width?(h.width=t.width,h.height=Math.floor(h.width/e)):_>e&&t.height<i.height?(h.height=t.height,h.width=Math.floor(h.height*e)):(h.width=i.width,h.height=i.height),h.left=Math.floor((t.width-h.width)/2),h.top=Math.floor((t.height-h.height)/2),h.ratio=h.width/i.width,h},l.__doCalClipPosition=function(i,t){var e={},_=i.width/t.width,h=this.__ratio/_;return e.top=Math.floor(i.top/_),e.left=Math.floor(i.left/_),e.width=Math.floor(this.__image.width*h),e.height=Math.floor(this.__image.height*h),e},l.__onImageLoad=function(){var i={position:"absolute",top:0,left:0,width:"100%",height:"100%"},t=function(i){h._$loop(i,function(i,t,e){e[t]=i+"px"})};return function(o){if(this.__image.src!=e._$BLANK_IMAGE&&(this._$dispatchEvent("onafterimageload",{parent:this.__mbox,loaded:o}),o)){var r=this.__doCalImagePosition({width:this.__image.width,height:this.__image.height},{width:this.__mbox.clientWidth,height:this.__mbox.clientHeight});({width:r.width,height:r.height});this.__sopt.max={width:r.width,height:r.height},this.__ratio=r.ratio,delete r.ratio,t(r),this.__cbox=_._$create("div"),r.position="absolute",_._$style(this.__cbox,r),this.__mbox.appendChild(this.__cbox),h._$forEach([new Image,new Image],function(t,e){i.zIndex=100+e,_._$style(t,i),this.__cbox.appendChild(t),t.src=this.__image.src,0==e&&_._$setStyle(t,"opacity",.3),t.draggable=!1},this);var a={ratio:this.__ratio,parent:this.__mbox};if(this._$dispatchEvent("onafterimageshow",a),a.value instanceof s._$$Resizer)this.__resizer=a.value;else{var n=h._$merge(this.__sopt,a.value);this.__sopt.parent=this.__cbox,this.__resizer=s._$$Resizer._$allocate(n)}this.__resizer._$batEvent(this.__ropt),this.__onClipping(this.__resizer._$getResizeBox())}}}(),l.__onClipping=function(i){var t=this.__cbox.getElementsByTagName("IMG")[1],e=[i.top+"px",i.left+i.width+"px",i.top+i.height+"px",i.left+"px"];_._$setStyle(t,"clip","rect("+e.join(" ")+")"),h._$forIn(this.__pbox,function(t){this.__doPreviewClip(t,i)},this),i.ratio=this.__ratio,this._$dispatchEvent("onclipchange",i)},l.__doPreviewClip=function(i,t){t||(t=this.__resizer._$getResizeBox());var e=this.__doCalClipPosition(t,i);i.clip={top:e.top,left:e.left,width:i.width,height:i.height,scale:e.width/this.__image.width};var h=_._$get(i.img)||new Image,o={position:"absolute",top:0-e.top+"px",left:0-e.left+"px",width:e.width+"px",height:e.height+"px"};_._$style(h,o),i.img||(i.img=_._$id(h),_._$get(i.box).appendChild(h),h.src=this.__image.src)},l._$setURL=function(i){i&&(this.__doClearResizer(),this.__doClearPreview(!0),this._$dispatchEvent("onbeforeimageload",{parent:this.__mbox}),this.__image.src=i)},l._$addPreview=function(i){var i=_._$get(i);if(i){var t=_._$id(i),e=i.clientWidth,h=i.clientHeight;this.__pbox[t]={box:t,width:e,height:h,ratio:e/h},this.__resizer&&this.__doPreviewClip(this.__pbox[t])}},l._$delPreview=function(i,t){var e=this.__pbox[i];e&&!t&&_._$remove(e.img),delete this.__pbox[i]},l._$getClipResult=function(i){var t=this.__pbox[i];if(t)return t.clip;var e={};return h._$forIn(this.__pbox,function(i,t){e[t]=i.clip}),e},l._$update=function(i){this.__resizer&&this.__resizer._$update(i)},CMPT&&i.copy(i.P("nej.ut"),r),r});