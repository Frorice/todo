NEJ.define(["base/klass","base/element","base/event","util/event","util/helper/select","util/cursor/cursor"],function(t,e,_,i,s,n,h,o,r,p,u){return h._$$At=t._$klass(),u=h._$$At._$extend(i._$$EventTarget),u.__init=function(){this.__sopt={loopable:!0,onselect:this.__onSelect._$bind(this)},this.__super()},u.__reset=function(t){this.__super(t),this.__keyword=t.keychar||"@",this.__input=e._$get(t.input),this.__sopt.parent=e._$get(t.tip),this.__sopt.selected=t.selected||"js-selected",this.__doInitDomEvent([[this.__input,"input",this.__onInput._$bind(this)],[this.__input,"keydown",this.__onKeyCheck._$bind(this)],[this.__input,"mouseup",this.__onInput._$bind(this)]]),this._$visibile(!1)},u.__destroy=function(){this.__super(),this.__helper&&(this.__helper._$recycle(),delete this.__helper),delete this.__input,delete this.__sopt.parent},u.__doUpdateTipPosition=function(){var t=n._$coordinate(this.__input);e._$style(this.__sopt.parent,{top:t.top+t.height+"px",left:t.left+"px"})},u.__onInput=function(){var t=/[\s\b]/;return function(e){for(var _,i=n._$cursor(this.__input),s=this.__input.value,h=[],o=i.start;o>=0&&(_=s.charAt(o),!t.test(_))&&(h.unshift(_),_!==this.__keyword);o--);return h[0]!=this.__keyword?void this._$update():(h.shift(),this.__doUpdateTipPosition(),void this._$dispatchEvent("onatchange",{keyword:this.__keyword,value:h.join("")}))}}(),u.__onSelect=function(t){var _=e._$dataset(t.target,"value");if(_){_+=" ";for(var i=n._$cursor(this.__input),s=this.__input.value,h=i.start;h>=0&&s.charAt(h)!=this.__keyword;h--);this.__input.value=s.substr(0,h+1)+_+s.substr(i.end),n._$cursor(this.__input,{start:h+_.length+1})}this._$update()},u.__onKeyCheck=function(t){27==t.keyCode&&(_._$stop(t),this._$update())},u._$visibile=function(t){e._$setStyle(this.__sopt.parent,"visibility",t?"visible":"hidden"),!t&&this.__helper&&(this.__helper=this.__helper._$recycle()),t&&!this.__helper&&(this.__helper=s._$$SelectHelper._$allocate(this.__sopt))},u._$update=function(t){this.__sopt.parent.innerHTML=t||"&nbsp;",this._$visibile(!!t)},h});