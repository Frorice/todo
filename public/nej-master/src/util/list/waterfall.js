NEJ.define(["base/global","base/klass","base/event","base/element","base/util","util/template/tpl","./module.js"],function(t,_,e,i,s,h,n,o,r,d,f){var l;return o._$$ListModuleWF=_._$klass(),l=o._$$ListModuleWF._$extend(n._$$ListModule),l.__reset=function(t){this.__doResetMoreBtn(t.more),this.__sbody=i._$get(t.sbody),this.__doInitDomEvent([[this.__sbody,"scroll",this.__onCheckScroll._$bind(this)]]);var _=t.delta;null==_&&(_=30),this.__delta=Math.max(0,_);var e=parseInt(t.count)||0;this.__count=Math.max(0,e);var s=parseInt(t.number)||0;s>1&&s<=e&&(this.__number=s),this.__super(t)},l.__destroy=function(){this.__super(),this.__stimer&&(window.clearTimeout(this.__stimer),delete this.__stimer),delete this.__nmore,delete this.__sbody,delete this.__endskr,delete this.__nexting},l.__getPageInfo=function(t,_){var e=this.__first+(this.__count-1)*this.__limit,i=this.__count*this.__limit;return this.__super(e,t,i,_)},l.__doResetMoreBtn=function(t){this.__nmore=i._$get(t),this.__doInitDomEvent([[this.__nmore,"click",this._$next._$bind(this)]])},l.__doLoadNextByTimer=function(){this.__endskr||this._$next()},l.__doCheckScroll=function(t){if(!this.__endskr&&t&&this.__lbox.clientHeight){t.scrollHeight||(t=i._$getPageBox());var _=i._$offset(this.__lbox,this.__sbody),e=_.y+this.__lbox.offsetHeight-t.scrollTop-t.clientHeight,s=t.scrollHeight<=t.clientHeight;(e<=this.__delta||s&&!this.__endskr)&&(this.__stimer&&window.clearTimeout(this.__stimer),this.__stimer=window.setTimeout(this.__doLoadNextByTimer._$bind(this),0))}},l.__onCheckScroll=function(t){if(!this.__endskr){var _=e._$getElement(t);_||(_=i._$getPageBox()),this.__doCheckScroll(_)}},l.__doChangePage=function(t){if(this.__super(t),!t.stopped){this.__doClearListBox();var _=0;t.index>1&&(_=this.__first+((t.index-1)*this.__count-1)*this.__limit),this.__offset=_,this._$next()}},l.__doGenRequestOpt=function(t){if(this.__number){var _=t.offset>0?this.__limit:this.__first,e=_+this.__limit*(this.__number-1);this.__offset=t.offset+e,t.data.limit=e,t.limit=e,delete this.__number}return t},l.__cbListLoad=function(t){delete this.__nexting,this.__super(t)||this._$resize()},l.__cbListChange=function(t){if(!t.key||t.key==this.__ropt.key){switch(t.action){case"refresh":case"append":delete this.__nexting}this.__super(t)}},l.__doBeforeListLoad=function(){this.__doShowMessage("onbeforelistload","列表加载中..."),i._$setStyle(this.__nmore,"display","none")},l.__doBeforeListRender=function(t,_,e){var s=t.length,h=t.loaded?_+e>=s:_+e>s;if(this.__offset=Math.min(this.__offset,s),i._$setStyle(this.__nmore,"display",h?"none":""),h&&(this.__endskr=!0),this.__count>0){var n=this.__getPageInfo(_,t.length);if(this.__doSyncPager(n.index,n.total))return!0;var o=this.__first-this.__limit,r=this.__count*this.__limit;this.__endskr=(_+e-o)%r==0||h,i._$setStyle(this.__nmore,"display",this.__endskr?"none":""),this.__doSwitchPagerShow(this.__endskr&&n.total>1?"":"none")}},l.__doShowEmpty=function(){this.__offset=0,this.__endskr=!0,this.__doShowMessage("onemptylist","没有列表数据！")},l.__doShowListByJST=function(t,_){this.__lbox.insertAdjacentHTML(_||"beforeEnd",t)},l.__doShowListByItem=function(t){this.__items=this.__items||[],s._$isArray(t)?f.push.apply(this.__items,t):this.__items.push(t)},l.__cbItemAdd=function(t){i._$removeByEC(this.__ntip),this.__doCheckResult(t,"onafteradd");var _=t.flag;if(!t.stopped&&_){if(this.__count>0)return void this.__doRefreshByPager();this.__offset+=1,_==-1?this._$unshift(t.data):this._$append(t.data)}},l.__cbItemDelete=function(t){if(this.__doCheckResult(t,"onafterdelete"),!t.stopped){if(this.__count>0)return void this.__doRefreshByPager();var _=t.data[this.__iopt.pkey];if(this.__items){var e=h._$getItemById(this.__getItemId(_)),n=s._$indexOf(this.__items,e);n>=0&&(this.__items.splice(n,1),this.__offset-=1),e&&e._$recycle()}else{var o=this._$getItemBody(_);o&&(this.__offset-=1),i._$remove(o)}this.__offset<=0&&this._$next()}},l.__cbAppendList=function(t,_){t==this.__offset&&this._$isLoaded()&&(this.__endskr=!1,this._$resize())},l.__cbUnshiftList=function(t,_){if(0==t)for(var e=this.__cache._$getListInCache(this.__ropt.key),i=_-1;i>=0;i--)this._$unshift(e[i])},l._$resize=function(){var t=this.__sbody;t&&!this.__endskr&&this.__doCheckScroll(this.__sbody)},l._$refresh=function(){delete this.__endskr,this.__super()},l._$next=function(){if(!this.__nexting){this.__nexting=!0;var t=this.__offset;this.__offset+=0==t?this.__first:this.__limit,this.__doChangeOffset(t)}},CMPT&&t.copy(t.P("nej.ut"),o),o});