NEJ.define(["base/global","base/klass","base/util","base/event","base/element","ui/item/list","ui/pager/pager","util/event","util/template/jst","util/template/tpl","util/cache/list"],function(t,e,_,i,s,h,o,a,n,r,d,p,l,c,f){var $;return p._$$ListModule=e._$klass(),$=p._$$ListModule._$extend(a._$$EventTarget),$.__reset=function(t){this.__ropt={},this.__super(t),this.__lbox=s._$get(t.parent),this.__iopt={parent:this.__lbox},this.__limit=parseInt(t.limit)||10,this.__first=parseInt(t.first)||this.__limit,this.__doResetTemplate(t.item),this.__doResetCache(t.cache||l),this.__doResetPager(t.pager||l),this._$refresh()},$.__destroy=function(){this._$dispatchEvent("onbeforerecycle"),this.__doClearListBox(),this.__super(),this.__ropt.clear&&this.__cache._$clearListInCache(this.__ropt.key),this.__cache._$recycle(),this.__pager&&(this.__pager._$recycle(),delete this.__pager),delete this.__pkls,delete this.__popt,delete this.__pulling,delete this.__cache,delete this.__lbox,delete this.__ikls,delete this.__iopt,delete this.__iext,delete this.__ropt},$.__getItemBodyId=function(t){return this.__getItemId(t)+n._$seed()},$.__getItemId=function(t){var e=(this.__iopt||l).prefix||"";return e+t},$.__getPageInfo=function(t,e,_,i){var s={index:1,total:1};return e>=t&&(s.index=Math.floor((e-t)/_)+2),i>t&&(s.total=Math.ceil((i-t)/_)+1),s},$.__doResetJSTTemplate=function(t){delete this.__ikls,this.__ikey=t,this.__doInitDomEvent([[this.__lbox,"click",this.__onCheckAction._$bind(this)]])},$.__doResetTemplate=function(t){if(_._$isString(t))return void this.__doResetJSTTemplate(t);_._$merge(this.__iopt,t),this.__iext=_._$merge({},t,function(t){return!_._$isFunction(t)});var e=this.__iopt.klass;return delete this.__iopt.klass,_._$isString(e)?void this.__doResetJSTTemplate(e):(delete this.__ikey,this.__ikls=e,this.__iopt.ondelete=this._$dispatchEvent._$bind(this,"ondelete"),void(this.__iopt.onupdate=this._$dispatchEvent._$bind(this,"onupdate")))},$.__doResetCache=function(t){var e=t.klass,i=_._$merge({},t);this.__ropt.key=i.lkey,this.__ropt.ext=i.ext,this.__ropt.data=i.data||{},this.__ropt.clear=!!i.clear,this.__iopt.pkey=i.key||"id",i.onerror=this._$dispatchEvent._$bind(this,"onerror"),i.onlistload=this.__cbListLoad._$bind(this),i.onpullrefresh=this.__cbPullRefresh._$bind(this),e&&"onlistchange"in e?this.__doInitDomEvent([[e,"listchange",this.__cbListChange._$bind(this)]]):(i.onitemadd=this.__cbItemAdd._$bind(this),i.onitemdelete=this.__cbItemDelete._$bind(this),i.onitemupdate=this.__cbItemUpdate._$bind(this)),this.__cache=(e||d._$$CacheList)._$allocate(i),null!=t.total&&this.__cache._$setTotal(this.__ropt.key,t.total),t.list&&this.__cache._$setListInCache(this.__ropt.key,t.list)},$.__doResetPager=function(t){this.__pkls=t.klass||o._$$Pager,this.__popt=_._$merge({},t),_._$isArray(t.parent)&&(this.__popt.parent=t.parent[0],this.__pbid=t.parent.slice(1),this.__pbid&&this.__pbid.length||delete this.__pbid),delete this.__popt.klass},$.__doClearListBox=function(){var t=/^(?:table|tr|tbody|ul|ol|select)$/i;return function(){this._$dispatchEvent("onbeforelistclear",{parent:this.__lbox}),this.__items&&this.__items.length>0&&(this.__items=this.__ikls._$recycle(this.__items),delete this.__items),t.test(this.__lbox.tagName)?s._$clearChildren(this.__lbox):this.__lbox.innerHTML=""}}(),$.__doSwitchPagerShow=function(t){this.__popt.fixed||(s._$setStyle(this.__popt.parent,"display",t),_._$forEach(this.__pbid,function(e){s._$setStyle(e,"display",t)},this))},$.__doRefreshByPager=function(){var t=this.__popt.index||1;delete this.__popt.index,this.__pager&&(t=this.__pager._$getIndex()),this.__doChangePage({last:t,index:t})},$.__doChangePage=function(t){this._$dispatchEvent("onpagechange",t)},$.__doChangeOffset=function(t){this.__ropt.offset=t,this.__doBeforeListLoad(),this.__doLoadList()},$.__doGenRequestOpt=function(t){return t},$.__doLoadList=function(){var t=this.__ropt.data;t.offset=this.__ropt.offset;var e=0==t.offset;t.total=e,this.__ropt.limit=e?this.__first:this.__limit,t.limit=this.__ropt.limit,this.__cache._$getList(this.__doGenRequestOpt(_._$merge({},this.__ropt)))},$.__cbListLoad=function(t){if(t.key==this.__ropt.key&&t.offset==this.__ropt.offset){this.__doBeforeListShow();var e=this.__cache._$getListInCache(t.key);if(!e||!e.length)return this._$cache()._$isLoaded(t.key)?this.__doShowEmpty():this.__doShowMessage("onlistloaderror","列表加载失败"),!0;var _=t.limit,i=t.offset;if(!this.__cache._$isFragmentFilled(t.key,i,_))return this.__doShowMessage("onlistloaderror","列表加载失败"),!0;if(!this.__doBeforeListRender(e,i,_)){if(this._$dispatchEvent("onbeforelistrender",{list:e,limit:_,offset:i,parent:this.__lbox,total:this.__cache._$getTotal(t.key)}),this.__ikey){this.__iopt.xlist=e,this.__iopt.beg=i,this.__iopt.end=Math.min(e.length,i+_)-1,this.__iopt.act="list";var s=n._$get(this.__ikey,this.__iopt,this.__iext);this.__doShowListByJST(s)}else{this.__iopt.limit=_,this.__iopt.offset=i;var h=r._$getItemTemplate(e,this.__ikls,this.__iopt);this.__doShowListByItem(h)}this._$dispatchEvent("onafterlistrender",{list:e,limit:_,offset:i,parent:this.__lbox,total:this.__cache._$getTotal(t.key)})}}},$.__cbPullRefresh=function(t){this.__pulling&&(delete this.__pulling,this.__doBeforeListShow("onafterpullrefresh"),this._$refresh())},$.__doSyncPager=function(t,e){if(this.__pager){(this.__popt||l).limit>0&&(e=Math.min(e,this.__popt.limit));var i=this.__pager._$getIndex(),s=this.__pager._$getTotal();if(i>e||e!=s)return this.__pager._$recycle(),delete this.__pager,this.__doChangePage({last:i,index:Math.min(t,e)}),!0}else this.__popt.index=t,this.__popt.total=e,this.__pager=this.__pkls._$allocate(this.__popt),this.__pager._$setEvent("onchange",this.__doChangePage._$bind(this)),_._$forEach(this.__pbid,function(t){this.__pager._$bind(t)},this)},$.__doFormatData=function(){var t=+new Date;return function(e){var _=e[this.__iopt.pkey];return _||(e["dirty-data"]=!0,e[this.__iopt.pkey]="dirty-"+t++),e}}(),$.__doSplitDirty=function(t){var e=t[this.__iopt.pkey];return t["dirty-data"]&&(delete t["dirty-data"],delete t[this.__iopt.pkey]),e},$.__doInsertOneItem=function(){var t=function(t,e){this.__lbox.insertAdjacentElement(t,e)};return function(e,i){var s=[i];if(this.__ikey){var s=this.__cache._$getListInCache(this.__ropt.key),h=_._$indexOf(s,i);h<0&&(h=0,s=[i]),this.__iopt.xlist=s,this.__iopt.beg=h,this.__iopt.end=h,this.__iopt.act="add",this.__doShowListByJST(n._$get(this.__ikey,this.__iopt,this.__iext),e)}else{this.__iopt.limit=1,this.__iopt.offset=0,this.__iopt.parent=t._$bind(this,e);var o=r._$getItemTemplate(s,this.__ikls,this.__iopt);this.__iopt.parent=this.__lbox,this.__doShowListByItem(o)}this._$dispatchEvent("onafterinsert")}}(),$.__doBeforeListLoad=c,$.__doBeforeListShow=function(t){var e={parent:this.__lbox};this._$dispatchEvent(t||"onafterlistload",e),e.stopped||s._$removeByEC(this.__ntip)},$.__doBeforeListRender=c,$.__doRenderMessage=function(t,e){_._$isString(t)?(this.__ntip||(this.__ntip=s._$create("div")),this.__ntip.innerHTML=t):this.__ntip=t,this.__lbox.insertAdjacentElement(e||"beforeEnd",this.__ntip)},$.__doShowMessage=function(t,e,_){var i={parent:this.__lbox};t&&this._$dispatchEvent(t,i),i.stopped||this.__doRenderMessage(i.value||e,_)},$.__doShowEmpty=c,$.__doShowListByJST=c,$.__doShowListByItem=c,$.__onCheckAction=function(){var t=/^(?:delete|update)$/;return function(e){var _=i._$getElement(e,"d:action");if(_){var h=s._$dataset(_,"action");if(t.test(h)){var o=s._$dataset(_,"id");if(o){var a=this.__cache._$getItemInCache(o);a&&(i._$stop(e),this._$dispatchEvent("on"+h,{data:a,id:a[this.__iopt.pkey],body:s._$get(this.__getItemBodyId(o))}))}}}}}(),$.__cbItemAdd=c,$.__doDeleteItem=function(t){var e=t.data||{},_={data:e,key:this.__ropt.key,id:e[this.__iopt.pkey]};this._$dispatchEvent("onbeforedelete",_),this.__cache._$deleteItem(_)},$.__cbItemDelete=c,$.__doUpdateItem=function(t){var e=t.data||{},_={data:e,key:this.__ropt.key};this._$dispatchEvent("onbeforeupdate",_),this.__cache._$updateItem(_)},$.__cbItemUpdate=function(t){if(this.__doCheckResult(t,"onafterupdate"),!t.stopped){var e=t.data[this.__iopt.pkey];if(this.__items){var i=r._$getItemById(this.__getItemId(e));i&&i._$refresh(t.data)}else{var h=this._$getItemBody(e);if(!h)return;var o=this.__cache._$getListInCache(this.__ropt.key),a=_._$indexOf(o,t.data);if(a<0)return;this.__iopt.xlist=o,this.__iopt.beg=a,this.__iopt.end=a,this.__iopt.act="update";var d=n._$get(this.__ikey,this.__iopt,this.__iext);h.insertAdjacentHTML("afterEnd",d),s._$remove(h)}this._$dispatchEvent("onafterupdaterender",{data:t.data,parent:this.__lbox})}},$.__doCheckResult=function(t,e){var _=t.data;_&&null!=_[this.__iopt.pkey]||(this._$dispatchEvent("onerror",t),t.stopped=!0),t.stopped||this._$dispatchEvent(e,t)},$.__cbAppendList=c,$.__cbUnshiftList=c,$.__cbListChange=function(t){if(!t.key||t.key==this.__ropt.key)switch(t.action){case"add":this.__cbItemAdd(t);break;case"delete":this.__cbItemDelete(t);break;case"update":this.__cbItemUpdate(t);break;case"refresh":this._$refresh();break;case"unshift":this.__cbUnshiftList(t.offset,t.limit);break;case"append":this.__cbAppendList(t.offset,t.limit)}},$._$update=function(t){this.__doUpdateItem({data:t})},$._$delete=function(t){this.__doDeleteItem({data:t})},$._$add=function(t){this.__cache._$addItem({data:t,key:this.__ropt.key})},$._$cache=function(){return this.__cache},$._$unshift=function(t){return this.__doInsertOneItem("afterBegin",this.__doFormatData(t)),this.__doSplitDirty(t)},$._$append=function(t){return this.__doInsertOneItem("beforeEnd",this.__doFormatData(t)),this.__doSplitDirty(t)},$._$refresh=function(){this.__doClearListBox(),this.__doRefreshByPager()},$._$refreshWithClear=function(){this.__cache._$clearListInCache(this.__ropt.key),this._$refresh()},$._$reload=function(t){t||this.__cache._$clearListInCache(this.__ropt.key),this.__doLoadList()},$._$pullRefresh=function(){this.__pulling||(this.__pulling=!0,this.__doShowMessage("onbeforepullrefresh","列表刷新中...","afterBegin"),this.__cache._$pullRefresh({key:this.__ropt.key,data:this.__ropt.data}))},$._$getTotal=function(){return this.__cache._$getTotal(this.__ropt.key)},$._$getPager=function(){return this.__pager},$._$items=function(){return this.__items},$._$getItemBody=function(t){if(this.__ikey)return s._$get(this.__getItemBodyId(t));var e=r._$getItemById(this.__getItemId(t));return e?e._$getBody():void 0},$._$isLoaded=function(){return this.__cache._$isLoaded(this.__ropt.key)},$._$showMessage=function(t){this.__doClearListBox(),this.__doShowMessage(null,t)},$._$nextPage=function(){if(this.__pager){var t=this.__pager._$getIndex()+1,e=this.__pager._$getTotal();return t=Math.max(1,Math.min(t,e)),this._$pageTo(t),t<e}},$._$prevPage=function(){if(this.__pager){var t=this.__pager._$getIndex()-1,e=this.__pager._$getTotal();return t=Math.max(1,Math.min(t,e)),this._$pageTo(t),t<=1}},$._$pageTo=function(t){if(this.__pager){var e=this.__pager._$getTotal();t=Math.max(1,Math.min(t,e)),this.__pager._$setIndex(t)}},CMPT&&t.copy(t.P("nej.ut"),p),p});