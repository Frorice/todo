NEJ.define(["base/global","base/klass","base/event","base/element","base/util","util/event","util/scroll/smart"],function(t,_,e,i,s,o,r,h,l,a,n,d){return h._$$Sortable=_._$klass(),d=h._$$Sortable._$extend(o._$$EventTarget),d.__reset=function(t){this.__super(t),this.__clazz=t.clazz||"j-sortable",this.__trigger=t.trigger||this.__clazz,this.__selected=t.selected||"j-selected",this.__viewport=i._$get(t.viewport),this.__parent=i._$get(t.parent),this.__holder=i._$get(t.placeholder),this.__thumb=i._$get(t.thumbnail),this.__delta=parseInt(t.delta)||0,i._$removeByEC(this.__thumb),i._$removeByEC(this.__holder),this.__doInitDomEvent([[this.__parent,"mousedown",this.__onSortStart._$bind(this)],[document,"mousemove",this.__onSorting._$bind(this)],[document,"mouseup",this.__onSortEnd._$bind(this)],[this.__holder,"mousemove",e._$stop._$bind(e)]])},d.__destroy=function(){this.__super(),this.__doClearSort()},d.__getScrollParent=function(){var t=this.__parent;return t.scrollHeight>t.offsetHeight?t:i._$getScrollViewPort(t)},d.__doClearSort=function(){var t=function(_,e){return s._$isArray(_)?void s._$forEach(_,function(_){t(_,e)}):void i._$delClassName(_,e)};return function(){this.__doUpdateThumb(3),i._$removeByEC(this.__holder),t(this.__lsort,this.__selected),this.__auto&&(this.__auto._$recycle(),delete this.__auto),delete this.__lsort,delete this.__place,delete this.__offset,delete this.__pointer}}(),d.__doUpdateThumb=function(t,_){if(this.__thumb){_=_||l;var e={state:t,top:_.y||0,left:_.x||0,target:this.__thumb,source:this.__lsort};return 3!=t&&document.body.appendChild(this.__thumb),this._$dispatchEvent("onthumbupdate",e),3==t?void i._$removeByEC(this.__thumb):void(e.stopped||i._$style(this.__thumb,{top:e.top+"px",left:e.left+"px"}))}},d.__doUpdateHolder=function(){var t=function(t,_){var e=i._$offset(t,_);return{top:e.y,left:e.x,width:t.clientWidth,height:t.clientHeight}};return function(_,e){this.__parent.appendChild(this.__holder);var s=t(_,this.__parent);this.__place=this.__doCalPlaceHolder(s,{top:e.y-s.top-this.__offset.y,left:e.x-s.left-this.__offset.x}),this.__place.ref=_,this.__place.source=this.__lsort,this.__place.target=this.__holder,this._$dispatchEvent("onholderupdate",this.__place),this.__place.stopped||(i._$style(this.__holder,{top:this.__place.top+"px",left:this.__place.left+"px"}),null!=this.__place.width&&i._$setStyle(this.__holder,"width",this.__place.width+"px"),null!=this.__place.height&&i._$setStyle(this.__holder,"height",this.__place.height+"px"))}}(),d.__doCalPlaceHolder=a,d.__canStartSort=a,d.__onSortStart=function(t){var _=e._$getElement(t,"c:"+this.__trigger);if(_){e._$stop(t),this.__lsort=_,i._$hasClassName(_,this.__clazz)||(this.__lsort=e._$getElement(t,"c:"+this.__clazz));try{var s={target:this.__lsort};this._$dispatchEvent("onbeforesort",s),s.value&&(this.__lsort=s.value||this.__lsort)}catch(t){}this.__offset=i._$offset(this.__parent),this.__pointer={x:e._$clientX(t),y:e._$clientY(t)}}},d.__onSorting=function(t){if(this.__lsort){var _={x:e._$clientX(t),y:e._$clientY(t)};if(!this.__auto){if(!this.__canStartSort(this.__pointer,_))return;var o=s._$isArray(this.__lsort);o||i._$addClassName(this.__lsort,this.__selected),this.__doUpdateThumb(1,_);var h=o?this.__lsort[0]:this.__lsort;this.__auto=r._$$SmartScroll._$allocate({viewport:this.__getScrollParent(),step:h.offsetHeight/5})}this.__doUpdateThumb(2,_);var l=e._$getElement(t,"c:"+this.__clazz);if(l)return l==this.__lsort?(delete this.__place,void i._$removeByEC(this.__holder)):void this.__doUpdateHolder(l,{x:e._$pageX(t),y:e._$pageY(t)})}},d.__onSortEnd=function(){var t=function(t,_){if(_){if(!s._$isArray(t))return void _.ref.insertAdjacentElement(_.position,t);for(var e;e=t[_.method]();)_.ref.insertAdjacentElement(_.position,e)}};return function(_){this.__lsort&&(t(this.__lsort,this.__place),this.__doClearSort(),this._$dispatchEvent("onsortchange"))}}(),d._$getSortList=function(){var t=[];return s._$forEach(i._$getByClassName(this.__parent,this.__clazz),function(_){t.push(i._$dataset(_,"value")||_)}),t},CMPT&&t.copy(t.P("nej.ut"),h),h});