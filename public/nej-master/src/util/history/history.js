NEJ.define(["base/util","base/event","base/platform","util/event/event","util/timer/animation","{platform}history.js"],function(e,n,t,o,i,r,a,c,u,l){var s=/^[#?]+/,f=/#(.*?)$/,h=this,p=function(){return!history.pushState||t._$IS.android||!history.auto},v=function(e,n){var t=n?"replaceState":"pushState";h.history[t](null,document.title,e)},d=function(){return location.parse(h.location.href)};return v=v._$aop(function(e){if(p()){e.stopped=!0;var n=e.args;_url=n[0].replace(s,""),n[1]?h.location.replace("#"+_url):h.location.hash=_url}}),d=d._$aop(function(e){if(p()){e.stopped=!0;var n=f.test(h.location.href)?RegExp.$1:"";e.value=location.parse(n.replace(s,""))}}),location.redirect=function(e,n){v(e,n)},location.active=function(){var e,o,a,c,u,l=function(e){if(c)return void(c=!1);var t={oldValue:a,newValue:d()};if(location.ignored)location.ignored=!1;else if(n._$dispatchEvent(location,"beforeurlchange",t),t.stopped)return void(a&&(c=!0,v(a.href,!0)));o=h.location.href,a=t.newValue,n._$dispatchEvent(location,"urlchange",a),r.__pushHistory(a.href)},s=function(){o!=h.location.href&&l(),e=i.requestAnimationFrame(s)},f=function(){var e=t._$KERNEL;return _ie7="trident"==e.engine&&e.release<="3.0",p()&&"onhashchange"in window&&!_ie7};return function(t){u||(u=!0,h=t||window,f()?(n._$addEvent(h,"hashchange",l),l()):e||(e=i.requestAnimationFrame(s),s()))}}(),location.parse=function(){var n=/^https?:\/\/.*?\//i,t=/[?#]/;return function(o){var i={href:o};o=(o||"").replace(n,"/").split(t);var r=1;return"/"==o[0]&&0==(o[1]||"").indexOf("/")&&(r=2),i.path=o.splice(0,r).join("?"),i.query=e._$query2object(o.join("&")),i}}(),location.same=function(e){return d().href==e},o._$$CustomEvent._$allocate({element:location,event:["beforeurlchange","urlchange"]}),a});